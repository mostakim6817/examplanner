<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f2f4f7;margin:0;padding:12px}
.container{max-width:900px;margin:auto;background:#fff;padding:16px;border-radius:6px}
input,textarea{width:100%;padding:10px;margin:6px 0}
button{padding:10px;width:100%;margin-top:8px;border:none;border-radius:4px}
.primary{background:#0275d8;color:#fff}
.danger{background:#d9534f;color:#fff}
.box{background:#eef3ff;padding:12px;margin-top:12px}
.history{background:#f9f9f9;padding:10px;margin-bottom:10px;border-left:4px solid #0275d8}
</style>
</head>

<body>
<div class="container">
<h2>Admin Panel</h2>

<h3>Create Exam</h3>
<input id="title" placeholder="Exam Title">
<input id="date" placeholder="Exam Date">

<label><input type="checkbox" id="enableTimer"> Enable Timer</label>
<input id="duration" placeholder="Duration (minutes)" class="hidden">

<textarea id="questions" placeholder="Paste MCQ JSON"></textarea>
<button class="primary" onclick="createExam()">Create Exam</button>
<div class="box" id="linkBox"></div>

<hr>

<h3>Attempts</h3>
<button class="primary" onclick="loadAttempts()">Load Attempts</button>
<button class="danger" onclick="resetAttempts()">Reset All</button>
<div class="box" id="historyBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

enableTimer.onchange=()=>duration.classList.toggle("hidden",!enableTimer.checked);

window.createExam=async function(){
  const qs=JSON.parse(questions.value);
  const ref=await addDoc(collection(db,"exams"),{
    title:title.value,
    date:date.value,
    enableTimer:enableTimer.checked,
    durationMin:enableTimer.checked?Number(duration.value):null,
    questions:qs
  });
  const base=location.origin+location.pathname.replace(/\/[^\/]*$/,"/");
  linkBox.innerHTML=`Exam Link:<br><input value="${base}index.html?exam=${ref.id}" readonly>`;
};

window.loadAttempts=async function(){
  const q=query(collection(db,"attempts"),orderBy("startTime","desc"));
  const snap=await getDocs(q);
  let html="";
  snap.forEach(d=>{
    const a=d.data();
    html+=`
      <div class="history">
        <b>${a.examTitle}</b><br>
        Student: ${a.student}<br>
        Status: ${a.status}<br>
        ${a.status==="COMPLETED"
          ?`Score: ${a.correct}/${a.total} (${a.percent}%)<br>
            Time: ${Math.floor(a.durationSec/60)}m ${a.durationSec%60}s`
          :"Score: Waiting"}
      </div>`;
  });
  historyBox.innerHTML=html;
};

window.resetAttempts=async function(){
  const snap=await getDocs(collection(db,"attempts"));
  for(const d of snap.docs) await deleteDoc(doc(db,"attempts",d.id));
  historyBox.innerHTML="All attempts deleted.";
};
</script>
</body>
</html>
