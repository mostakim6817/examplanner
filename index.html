<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:12px}
.container{max-width:900px;margin:auto;background:#fff;padding:16px;border-radius:6px}
.hidden{display:none}

.question{margin-bottom:18px}
.question b{display:block;margin-bottom:6px}

.option{margin:4px 0}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
.skipped{color:#6c757d;font-style:italic}

.explanation{
  background:#f1f1f1;
  padding:8px;
  margin-top:6px;
  border-left:4px solid #0275d8
}

button{
  width:100%;
  padding:10px;
  font-size:16px;
  border:none;
  border-radius:4px;
  background:#0275d8;
  color:#fff;
  margin-top:10px;
  cursor:pointer
}

.timer{font-weight:bold;margin-bottom:10px}

.result{
  background:#eef3ff;
  padding:12px;
  border-radius:4px;
  margin-top:16px
}
</style>
</head>

<body>
<div class="container">

<!-- NAME -->
<div id="nameBox">
  <h3>Enter Your Name</h3>
  <input id="studentName" placeholder="Your name" style="width:100%;padding:10px">
  <button onclick="startExam()">Start Exam</button>
</div>

<!-- EXAM -->
<div id="examBox" class="hidden">
  <h2 id="examTitle"></h2>
  <p>Date: <span id="examDate"></span></p>
  <div id="timerBox" class="timer hidden"></div>

  <form id="examForm"></form>
  <button id="submitBtn" onclick="submitExam()">Submit</button>

  <div id="resultBox" class="result"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, addDoc, updateDoc, collection
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* LOAD EXAM */
const examId = new URLSearchParams(location.search).get("exam");
if(!examId){
  document.body.innerHTML="Invalid exam link";
  throw "";
}

const examSnap = await getDoc(doc(db,"exams",examId));
if(!examSnap.exists()){
  document.body.innerHTML="Exam not found";
  throw "";
}

const exam = examSnap.data();
examTitle.innerText = exam.title;
examDate.innerText = exam.date;

const form = document.getElementById("examForm");

let attemptRef;
let startTime;
let timerInt=null;
let remaining=0;

/* START EXAM */
window.startExam = async ()=>{
  const name = studentName.value.trim();
  if(!name) return alert("Name required");

  nameBox.classList.add("hidden");
  examBox.classList.remove("hidden");

  startTime = Date.now();

  attemptRef = await addDoc(collection(db,"attempts"),{
    examId,
    examTitle: exam.title,
    student: name,
    status: "IN_PROGRESS",
    startTime: new Date()
  });

  exam.questions.forEach((q,i)=>{
    form.innerHTML += `
      <div class="question" data-i="${i}">
        <b>${i+1}. ${q.question}</b>
        ${q.options.map((o,idx)=>`
          <div class="option">
            <label>
              <input type="radio" name="q${i}" value="${idx}">
              ${o}
            </label>
          </div>
        `).join("")}
      </div>
    `;
  });

  if(exam.enableTimer){
    remaining = exam.durationMin * 60;
    timerBox.classList.remove("hidden");
    updateTimer();
    timerInt = setInterval(()=>{
      remaining--;
      updateTimer();
      if(remaining<=0){
        clearInterval(timerInt);
        submitExam();
      }
    },1000);
  }
};

function updateTimer(){
  timerBox.innerText =
    `⏱ ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,"0")}`;
}

/* SUBMIT */
window.submitExam = async ()=>{
  submitBtn.disabled = true;
  if(timerInt) clearInterval(timerInt);

  let correct=0, wrong=0, skipped=0;
  const answers=[];

  exam.questions.forEach((q,i)=>{
    const box=document.querySelector(`[data-i="${i}"]`);
    const sel=box.querySelector("input:checked");
    const selected = sel ? Number(sel.value) : null;

    answers[i] = { selected };

    box.querySelectorAll(".option").forEach((op,idx)=>{
      const label = op.querySelector("label");

      if(idx === q.correct){
        label.classList.add("correct");
        label.innerHTML = "✔ " + label.innerHTML;
      }

      if(selected !== null && idx === selected && selected !== q.correct){
        label.classList.add("wrong");
        label.innerHTML = "✘ " + label.innerHTML;
      }
    });

    if(selected === null){
      skipped++;
      box.innerHTML += `<div class="skipped">⏭ Skipped</div>`;
    }
    else if(selected === q.correct) correct++;
    else wrong++;

    if(q.explanation){
      box.innerHTML += `<div class="explanation">${q.explanation}</div>`;
    }
  });

  const total = exam.questions.length;
  const percent = ((correct/total)*100).toFixed(1);
  const durationSec = Math.floor((Date.now()-startTime)/1000);

  await updateDoc(attemptRef,{
    status:"COMPLETED",
    correct, wrong, skipped, total,
    percent,
    durationSec,
    answers,
    endTime: new Date()
  });

  resultBox.innerHTML = `
    <h3>Result</h3>
    ✔ Correct: ${correct}<br>
    ✘ Wrong: ${wrong}<br>
    ⏭ Skipped: ${skipped}<br>
    % Score: ${percent}%<br>
    ⏱ Time: ${Math.floor(durationSec/60)}m ${durationSec%60}s
  `;
};
</script>

</body>
</html>
