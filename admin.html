<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f2f4f7;margin:0;padding:12px}
.container{max-width:1100px;margin:auto;background:#fff;padding:16px;border-radius:6px}
input,textarea{width:100%;padding:10px;margin:6px 0;font-size:15px}
button{padding:10px;width:100%;margin-top:8px;border:none;border-radius:4px;font-size:15px;cursor:pointer}
.primary{background:#0275d8;color:#fff}
.danger{background:#d9534f;color:#fff}
.copy{background:#5cb85c;color:#fff}
.box{background:#eef3ff;padding:12px;margin-top:12px;border-radius:4px}
.card{background:#f9f9f9;padding:12px;margin-bottom:12px;border-left:4px solid #0275d8}
.question{background:#fff;padding:8px;margin-top:6px;border-radius:4px}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
.hidden{display:none}
.explanation{margin-top:6px;background:#f1f1f1;padding:6px;border-left:4px solid #0275d8}
</style>
</head>

<body>
<div class="container">

<h2>ADMIN PANEL</h2>

<h3>Exam Attempts</h3>
<button class="primary" onclick="toggleAttempts()">Load / Refresh History</button>
<div class="box hidden" id="historyBox"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  query, orderBy, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.toggleAttempts = async () => {
  const hidden = historyBox.classList.contains("hidden");
  historyBox.classList.toggle("hidden");
  if(!hidden) return;

  const q = query(collection(db,"attempts"),orderBy("startTime","desc"));
  const snap = await getDocs(q);

  let html="";
  snap.forEach(d=>{
    const a=d.data();
    html+=`
      <div class="card">
        <b>${a.examTitle}</b><br>
        Student: ${a.student}<br>
        Status: <b>${a.status}</b><br>
        ${
          a.status==="COMPLETED"
          ? `
            Correct: ${a.correct},
            Wrong: ${a.wrong},
            Skipped: ${a.skipped}<br>
            Time: ${Math.floor(a.durationSec/60)}m ${a.durationSec%60}s
          `
          : `
            Correct: — ,
            Wrong: — ,
            Skipped: —<br>
            Time: —
          `
        }
        <br>
        <button class="primary"
          onclick="viewAttempt('${d.id}','${a.examId}')">
          View Attempt
        </button>
        <div id="attempt_${d.id}" class="hidden"></div>
      </div>
    `;
  });

  historyBox.innerHTML = html || "No history found.";
};

window.viewAttempt = async (attemptId, examId) => {
  const box=document.getElementById("attempt_"+attemptId);
  box.classList.toggle("hidden");
  if(box.innerHTML) return;

  const attempt=(await getDoc(doc(db,"attempts",attemptId))).data();
  const exam=(await getDoc(doc(db,"exams",examId))).data();

  let html="";
  exam.questions.forEach((q,i)=>{
    const ua = attempt.answers?.[i]?.selected ?? null;

    html+=`<div class="question">
      <b>${i+1}. ${q.question}</b><br>`;

    q.options.forEach((o,idx)=>{
      if(idx===q.correct) html+=`<div class="correct">✔ ${o}</div>`;
      else if(idx===ua) html+=`<div class="wrong">✘ ${o}</div>`;
      else html+=`<div>${o}</div>`;
    });

    if(ua===null) html+=`<div class="wrong"><i>Skipped</i></div>`;
    if(q.explanation)
      html+=`<div class="explanation"><b>Explanation:</b> ${q.explanation}</div>`;

    html+=`</div>`;
  });

  box.innerHTML=html;
};
</script>
</body>
</html>
