<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:12px}
.container{max-width:900px;margin:auto;background:#fff;padding:16px;border-radius:6px}
.question{margin-bottom:16px}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
.explanation{background:#f9f9f9;padding:8px;margin-top:6px;border-left:4px solid #0275d8}
.result{background:#eef3ff;padding:12px;margin-top:20px;border-radius:4px}
.hidden{display:none}
button{padding:10px;font-size:16px;width:100%;border:none;border-radius:4px;background:#0275d8;color:#fff}
.timer{font-weight:bold;margin-bottom:10px}
</style>
</head>

<body>
<div class="container">

<div id="nameBox">
  <h3>Enter Your Name</h3>
  <input id="studentName" placeholder="Your name" style="width:100%;padding:10px">
  <button onclick="startExam()">Start Exam</button>
</div>

<div id="examBox" class="hidden">
  <h2 id="examTitle"></h2>
  <p>Date: <span id="examDate"></span></p>
  <div id="timerBox" class="timer hidden"></div>
  <form id="examForm"></form>
  <button id="submitBtn" onclick="submitExam()">Submit</button>
  <div class="result" id="resultBox"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, addDoc, updateDoc, collection
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const examId=new URLSearchParams(location.search).get("exam");
const snap=await getDoc(doc(db,"exams",examId));
const exam=snap.data();

examTitle.innerText=exam.title;
examDate.innerText=exam.date;

let startTime, attemptRef, timerInt, remaining;
const form=examForm;

window.startExam=async ()=>{
  const name=studentName.value.trim();
  if(!name) return alert("Name required");

  nameBox.classList.add("hidden");
  examBox.classList.remove("hidden");
  startTime=Date.now();

  attemptRef=await addDoc(collection(db,"attempts"),{
    examTitle:exam.title,
    student:name,
    startTime:new Date(),
    status:"IN_PROGRESS"
  });

  exam.questions.forEach((q,i)=>{
    form.innerHTML+=`
      <div class="question" data-i="${i}">
        ${i+1}. ${q.question}<br>
        ${q.options.map((o,idx)=>`
          <label><input type="radio" name="q${i}" value="${idx}"> ${o}</label>
        `).join("")}
      </div>
    `;
  });

  if(exam.enableTimer){
    remaining=exam.durationMin*60;
    timerBox.classList.remove("hidden");
    timerInt=setInterval(()=>{
      remaining--;
      timerBox.innerText=`‚è± ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,"0")}`;
      if(remaining<=0){clearInterval(timerInt);submitExam();}
    },1000);
  }
};

window.submitExam=async ()=>{
  submitBtn.disabled=true;
  if(timerInt) clearInterval(timerInt);

  let correct=0, wrong=0, skipped=0;
  let answers=[];

  exam.questions.forEach((q,i)=>{
    const box=document.querySelector(`[data-i="${i}"]`);
    const sel=box.querySelector("input:checked");
    let selected=sel?Number(sel.value):null;

    if(selected===null) skipped++;
    else if(selected===q.correct) correct++;
    else wrong++;

    answers.push({
      question:q.question,
      options:q.options,
      correct:q.correct,
      selected
    });

    box.querySelectorAll("label").forEach((l,idx)=>{
      if(idx===q.correct) l.classList.add("correct");
      if(idx===selected && selected!==q.correct) l.classList.add("wrong");
    });

    if(q.explanation){
      box.innerHTML+=`<div class="explanation">${q.explanation}</div>`;
    }
  });

  const durationSec=Math.floor((Date.now()-startTime)/1000);

  await updateDoc(attemptRef,{
    status:"COMPLETED",
    correct,wrong,skipped,
    total:exam.questions.length,
    durationSec,
    answers
  });

  resultBox.innerHTML=`
    <h3>Result</h3>
    Correct: ${correct}<br>
    Wrong: ${wrong}<br>
    Skipped: ${skipped}<br>
    Time: ${Math.floor(durationSec/60)}m ${durationSec%60}s
  `;
};
</script>
</body>
</html>

