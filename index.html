<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Student Exam</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:800px;
  margin:auto;
  background:#ffffff;
  padding:25px;
  border-radius:6px;
}
.question{
  margin-bottom:20px;
}
.result{
  background:#eef3ff;
  padding:15px;
  margin-top:20px;
  border-radius:4px;
}
</style>
</head>

<body>

<div class="container">
<h2 id="examTitle"></h2>
<p><b>Date:</b> <span id="examDate"></span></p>

<form id="examForm"></form>

<button onclick="submitExam()">Submit</button>

<div class="result" id="resultBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  addDoc,
  collection
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* LOAD EXAM */
const examId = new URLSearchParams(window.location.search).get("exam");

if(!examId){
  document.body.innerHTML = "<h2>Invalid exam link</h2>";
  throw "";
}

const snap = await getDoc(doc(db,"exams",examId));

if(!snap.exists()){
  document.body.innerHTML = "<h2>Exam not found</h2>";
  throw "";
}

const exam = snap.data();

document.getElementById("examTitle").innerText = exam.title;
document.getElementById("examDate").innerText = exam.date;

const form = document.getElementById("examForm");

exam.questions.forEach((q,i)=>{
  let html = `<div class="question">
    <p>${i+1}. ${q.question}</p>`;
  q.options.forEach((opt,idx)=>{
    html += `
      <label>
        <input type="radio" name="${q.id}" value="${idx}">
        ${opt}
      </label><br>`;
  });
  html += `</div>`;
  form.innerHTML += html;
});

/* SUBMIT */
window.submitExam = async function(){
  let correct = 0;

  exam.questions.forEach(q=>{
    const sel = document.querySelector(
      `input[name="${q.id}"]:checked`
    );
    if(sel && Number(sel.value) === q.correct){
      correct++;
    }
  });

  const total = exam.questions.length;
  const percent = ((correct/total)*100).toFixed(2);

  await addDoc(collection(db,"results"),{
    examId: examId,
    title: exam.title,
    correct: correct,
    total: total,
    percent: percent,
    time: new Date(),
    link: window.location.href
  });

  document.getElementById("resultBox").innerHTML = `
    <h3>Result</h3>
    Correct: ${correct} / ${total}<br>
    Score: ${percent}%
  `;
};
</script>

</body>
</html>
