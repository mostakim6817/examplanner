<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:0;padding:12px}
.container{max-width:1200px;margin:auto;background:#fff;padding:16px;border-radius:6px}
input,textarea{width:100%;padding:10px;margin:6px 0}
button{padding:8px 10px;margin-top:6px;border:none;border-radius:4px;cursor:pointer}
.primary{background:#0275d8;color:#fff}
.danger{background:#d9534f;color:#fff}
.copy{background:#5cb85c;color:#fff}
.gray{background:#6c757d;color:#fff}
.box{background:#eef3ff;padding:12px;margin-top:12px;border-radius:4px}
.card{background:#f9f9f9;padding:12px;margin-bottom:12px;border-left:4px solid #0275d8}
.question{background:#fff;padding:8px;margin-top:6px}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
.hidden{display:none}
.explanation{background:#eee;padding:6px;border-left:4px solid #0275d8}
.flex{display:flex;gap:6px;flex-wrap:wrap}
small{color:#555}
</style>
</head>

<body>
<div class="container">

<h2>ADMIN PANEL</h2>

<!-- CREATE EXAM -->
<h3>Create Exam</h3>
<input id="title" placeholder="Exam Title">
<input id="date" placeholder="Exam Date">
<label><input type="checkbox" id="enableTimer"> Enable Timer</label>
<input id="duration" class="hidden" placeholder="Duration (minutes)">
<textarea id="questions" placeholder="Paste MCQ JSON"></textarea>
<button class="primary" onclick="createExam()">Create Exam</button>
<div class="box" id="linkBox"></div>

<hr>

<!-- EXAM MANAGER -->
<h3>Exam Manager</h3>
<button class="primary" onclick="toggleExams()">Load / Refresh Exams</button>
<div class="box hidden" id="examBox"></div>

<hr>

<!-- HISTORY -->
<h3>Exam History</h3>
<div class="flex">
  <button class="primary" onclick="toggleHistory()">Load / Refresh History</button>
  <button class="danger" onclick="resetHistory()">Delete All History</button>
</div>
<div class="box hidden" id="historyBox"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, getDoc,
  updateDoc, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

enableTimer.onchange = ()=>duration.classList.toggle("hidden",!enableTimer.checked);

const base = location.origin + location.pathname.replace(/\/[^\/]*$/,"/");

/* CREATE EXAM */
window.createExam = async ()=>{
  const qs = JSON.parse(questions.value);
  const ref = await addDoc(collection(db,"exams"),{
    title:title.value,
    date:date.value,
    enableTimer:enableTimer.checked,
    durationMin:enableTimer.checked?Number(duration.value):null,
    questions:qs,
    createdAt:new Date()
  });
  const link = `${base}index.html?exam=${ref.id}`;
  linkBox.innerHTML = `
    <b>Exam Created</b><br>
    <input id="newLink" value="${link}" readonly>
    <button class="copy" onclick="copy('newLink')">Copy Link</button>
  `;
};

window.copy = id=>{
  navigator.clipboard.writeText(document.getElementById(id).value);
};

/* EXAMS */
window.toggleExams = async ()=>{
  examBox.classList.toggle("hidden");
  if(examBox.classList.contains("hidden")) return;

  const snap = await getDocs(collection(db,"exams"));
  examBox.innerHTML = "";

  snap.forEach(d=>{
    const e=d.data();
    const link=`${base}index.html?exam=${d.id}`;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <b>${e.title}</b><br>
      Date: ${e.date}<br>
      <small>${link}</small><br>
      <div class="flex">
        <button class="copy" onclick="navigator.clipboard.writeText('${link}')">Copy Link</button>
        <button class="primary" onclick="viewQuestions('${d.id}')">View Questions</button>
        <button class="danger" onclick="deleteExam('${d.id}')">Delete Exam</button>
      </div>
      <div id="q_${d.id}" class="hidden"></div>
    `;
    examBox.appendChild(card);
  });
};

window.viewQuestions = async id=>{
  const box=document.getElementById("q_"+id);
  box.classList.toggle("hidden");
  if(box.innerHTML) return;

  const snap=await getDoc(doc(db,"exams",id));
  const exam=snap.data();

  exam.questions.forEach((q,i)=>{
    const qDiv=document.createElement("div");
    qDiv.className="question";
    qDiv.innerHTML=`
      <b>${i+1}. ${q.question}</b><br>
      ${q.options.map((o,idx)=>
        idx===q.correct?`<div class="correct">✔ ${o}</div>`:`<div>${o}</div>`
      ).join("")}
      ${q.explanation?`<div class="explanation">${q.explanation}</div>`:""}
      <button class="danger" onclick="deleteQuestion('${id}',${i})">Delete Question</button>
    `;
    box.appendChild(qDiv);
  });
};

window.deleteQuestion = async (examId,index)=>{
  if(!confirm("Delete this question?")) return;
  const ref=doc(db,"exams",examId);
  const snap=await getDoc(ref);
  const exam=snap.data();
  exam.questions.splice(index,1);
  await updateDoc(ref,{questions:exam.questions});
  document.getElementById("q_"+examId).innerHTML="";
  viewQuestions(examId);
};

window.deleteExam = async id=>{
  if(!confirm("Delete entire exam?")) return;
  await deleteDoc(doc(db,"exams",id));
  toggleExams();
};

/* HISTORY */
window.toggleHistory = async ()=>{
  historyBox.classList.toggle("hidden");
  if(historyBox.classList.contains("hidden")) return;

  const snap = await getDocs(
    query(collection(db,"attempts"), orderBy("startTime","desc"))
  );

  historyBox.innerHTML = "";

  snap.forEach(d=>{
    const a = d.data();

    const total = a.total ?? 0;
    const correct = a.correct ?? 0;
    const wrong = a.wrong ?? 0;
    const skipped = a.skipped ?? (total - correct - wrong);
    const percent = a.percent ?? (
      total ? ((correct/total)*100).toFixed(1) : "—"
    );

    const timeText = a.durationSec
      ? `${Math.floor(a.durationSec/60)}m ${a.durationSec%60}s`
      : "—";

    const statusBadge = a.status==="COMPLETED"
      ? `<span style="color:#28a745;font-weight:bold">COMPLETED</span>`
      : `<span style="color:#ffc107;font-weight:bold">IN PROGRESS</span>`;

    const link = `${base}index.html?exam=${a.examId}`;

    historyBox.innerHTML += `
      <div class="card">
        <b>${a.examTitle}</b><br>
        Student: <b>${a.student}</b><br>
        Status: ${statusBadge}<br>
        <small>${link}</small>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <span style="background:#d4edda;color:#155724;padding:4px 8px;border-radius:4px">
            ✔ Correct: ${a.status==="COMPLETED" ? correct : "—"}
          </span>

          <span style="background:#f8d7da;color:#721c24;padding:4px 8px;border-radius:4px">
            ✘ Wrong: ${a.status==="COMPLETED" ? wrong : "—"}
          </span>

          <span style="background:#e2e3e5;color:#383d41;padding:4px 8px;border-radius:4px">
            ⏭ Skipped: ${a.status==="COMPLETED" ? skipped : "—"}
          </span>

          <span style="background:#d1ecf1;color:#0c5460;padding:4px 8px;border-radius:4px">
            % ${a.status==="COMPLETED" ? percent : "—"}
          </span>

          <span style="background:#fff3cd;color:#856404;padding:4px 8px;border-radius:4px">
            ⏱ ${a.status==="COMPLETED" ? timeText : "—"}
          </span>
        </div>

        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
          <button class="copy" onclick="navigator.clipboard.writeText('${link}')">
            Copy Exam Link
          </button>
          <button class="primary" onclick="viewAttempt('${d.id}','${a.examId}')">
            View Attempt
          </button>
          <button class="danger" onclick="deleteAttempt('${d.id}')">
            Delete
          </button>
        </div>

        <div id="a_${d.id}" class="hidden"></div>
      </div>
    `;
  });

  if(!snap.size){
    historyBox.innerHTML = "<i>No history found</i>";
  }
};


window.viewAttempt = async (attemptId, examId) => {
  const box = document.getElementById("attempt_" + attemptId);
  box.classList.toggle("hidden");
  if (box.innerHTML) return;

  const attemptSnap = await getDoc(doc(db, "attempts", attemptId));
  const examSnap = await getDoc(doc(db, "exams", examId));

  const attempt = attemptSnap.data();
  const exam = examSnap.data();

  let html = "";

  exam.questions.forEach((q, i) => {
    const ans = attempt.answers?.[i]; // ✅ FIX
    const selected = ans ? ans.selected : null;

    html += `<div class="question"><b>${i + 1}. ${q.question}</b><br>`;

    q.options.forEach((o, idx) => {
      if (idx === q.correct) {
        html += `<div class="correct">✔ ${o}</div>`;
      } else if (idx === selected) {
        html += `<div class="wrong">✘ ${o}</div>`;
      } else {
        html += `<div>${o}</div>`;
      }
    });

    if (selected === null) {
      html += `<div class="wrong"><i>Skipped</i></div>`;
    }

    if (q.explanation) {
      html += `<div class="explanation"><b>Explanation:</b> ${q.explanation}</div>`;
    }

    html += `</div>`;
  });

  box.innerHTML = html;
};

};

window.deleteAttempt = async id=>{
  if(!confirm("Delete this attempt?")) return;
  await deleteDoc(doc(db,"attempts",id));
  toggleHistory();
};

window.resetHistory = async ()=>{
  if(!confirm("Delete ALL history?")) return;
  const snap=await getDocs(collection(db,"attempts"));
  for(const d of snap.docs) await deleteDoc(doc(db,"attempts",d.id));
  historyBox.innerHTML="";
};
</script>
</body>
</html>
