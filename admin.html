<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:0;padding:12px}
.container{max-width:1100px;margin:auto;background:#fff;padding:16px;border-radius:6px}
input,textarea{width:100%;padding:10px;margin:6px 0}
button{padding:10px;width:100%;margin-top:6px;border:none;border-radius:4px;cursor:pointer}
.primary{background:#0275d8;color:#fff}
.danger{background:#d9534f;color:#fff}
.copy{background:#5cb85c;color:#fff}
.box{background:#eef3ff;padding:12px;margin-top:12px;border-radius:4px}
.card{background:#f9f9f9;padding:12px;margin-bottom:12px;border-left:4px solid #0275d8}
.question{background:#fff;padding:8px;margin-top:6px}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
.hidden{display:none}
.explanation{background:#eee;padding:6px;border-left:4px solid #0275d8}
</style>
</head>

<body>
<div class="container">

<h2>ADMIN PANEL</h2>

<h3>Create Exam</h3>
<input id="title" placeholder="Exam Title">
<input id="date" placeholder="Exam Date">
<label><input type="checkbox" id="enableTimer"> Enable Timer</label>
<input id="duration" class="hidden" placeholder="Duration (minutes)">
<textarea id="questions" placeholder="Paste MCQ JSON"></textarea>
<button class="primary" onclick="createExam()">Create Exam</button>
<div class="box" id="linkBox"></div>

<hr>

<h3>Exam Manager</h3>
<button class="primary" onclick="toggleExams()">Load Exams</button>
<div class="box hidden" id="examBox"></div>

<hr>

<h3>Exam Attempts</h3>
<button class="primary" onclick="toggleAttempts()">Load / Refresh History</button>
<div class="box hidden" id="historyBox"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWdAho4vhY3yjhWohl7lr8iJ0TKCGVU3Y",
  authDomain: "exam-planner-61152.firebaseapp.com",
  projectId: "exam-planner-61152",
  storageBucket: "exam-planner-61152.firebasestorage.app",
  messagingSenderId: "686056934046",
  appId: "1:686056934046:web:751e7bdc6c723bb833898f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

enableTimer.onchange=()=>duration.classList.toggle("hidden",!enableTimer.checked);

window.createExam=async()=>{
  if(!title.value||!date.value||!questions.value) return alert("All fields required");
  const qs=JSON.parse(questions.value);
  const ref=await addDoc(collection(db,"exams"),{
    title:title.value,date:date.value,
    enableTimer:enableTimer.checked,
    durationMin:enableTimer.checked?Number(duration.value):null,
    questions:qs,createdAt:new Date()
  });
  const base=location.origin+location.pathname.replace(/\/[^\/]*$/,"/");
  linkBox.innerHTML=`<input id="l" value="${base}index.html?exam=${ref.id}" readonly>
  <button class="copy" onclick="navigator.clipboard.writeText(l.value)">Copy Link</button>`;
};

window.toggleExams=async()=>{
  examBox.classList.toggle("hidden");
  if(!examBox.innerHTML){
    const snap=await getDocs(collection(db,"exams"));
    examBox.innerHTML=[...snap.docs].map(d=>{
      const e=d.data();
      return `<div class="card"><b>${e.title}</b>
      <button class="primary" onclick="viewQuestions('${d.id}')">View Questions</button>
      <div id="q_${d.id}" class="hidden"></div></div>`;
    }).join("");
  }
};

window.viewQuestions=async id=>{
  const box=document.getElementById("q_"+id);
  box.classList.toggle("hidden");
  if(box.innerHTML) return;
  const e=(await getDoc(doc(db,"exams",id))).data();
  box.innerHTML=e.questions.map((q,i)=>`
    <div class="question"><b>${i+1}. ${q.question}</b><br>
    ${q.options.map((o,idx)=>idx===q.correct?`<div class="correct">✔ ${o}</div>`:`<div>${o}</div>`).join("")}
    ${q.explanation?`<div class="explanation">${q.explanation}</div>`:""}
    </div>`).join("");
};

window.toggleAttempts=async()=>{
  historyBox.classList.toggle("hidden");
  if(!historyBox.classList.contains("hidden")){
    const snap=await getDocs(query(collection(db,"attempts"),orderBy("startTime","desc")));
    historyBox.innerHTML=[...snap.docs].map(d=>{
      const a=d.data();
      return `<div class="card">
      <b>${a.examTitle}</b><br>Student:${a.student}<br>Status:${a.status}
      <button class="primary" onclick="viewAttempt('${d.id}','${a.examId}')">View Attempt</button>
      <div id="a_${d.id}" class="hidden"></div></div>`;
    }).join("");
  }
};

window.viewAttempt=async(id,eid)=>{
  const box=document.getElementById("a_"+id);
  box.classList.toggle("hidden");
  if(box.innerHTML) return;
  const a=(await getDoc(doc(db,"attempts",id))).data();
  const e=(await getDoc(doc(db,"exams",eid))).data();
  box.innerHTML=e.questions.map((q,i)=>{
    const ua=a.answers[i]?.selected??null;
    return `<div class="question"><b>${i+1}. ${q.question}</b><br>
    ${q.options.map((o,idx)=>{
      if(idx===q.correct) return `<div class="correct">✔ ${o}</div>`;
      if(idx===ua) return `<div class="wrong">✘ ${o}</div>`;
      return `<div>${o}</div>`;
    }).join("")}
    ${ua===null?`<div class="wrong">Skipped</div>`:""}
    ${q.explanation?`<div class="explanation">${q.explanation}</div>`:""}
    </div>`;
  }).join("");
};
</script>
</body>
</html>
